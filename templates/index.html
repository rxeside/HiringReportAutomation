{% extends "base.html" %}

{% block content %}
<div id="update-overlay" class="update-overlay hidden">
    <div class="update-box">
        <div class="spinner"></div>
        <p>Идет обновление данных, пожалуйста, подождите...</p>
    </div>
</div>

<div id="app-container" data-coworkers='{{ coworkers|tojson|safe }}' data-report='{{ report_data|tojson|safe }}'>
    <header class="header">
        <div class="header-left">
            <button id="refreshButton" class="btn btn-primary">Обновить сейчас</button>
        </div>
        <div class="header-center">
            <h1>Отчет по воронке найма</h1>
            <div id="last-updated-time" class="last-updated">
                {% if last_updated %}
                    Последнее обновление: {{ last_updated.strftime('%d.%m.%Y %H:%M:%S') }} МСК
                {% else %}
                    Данные еще не обновлялись.
                {% endif %}
            </div>
        </div>
        <div class="header-right">
            <a href="/download-report" class="btn btn-secondary">Скачать XLSX</a>
        </div>
    </header>

    <div class="toolbar">
         <div class="filter-group">
            <label for="vacancy-filter">Вакансия:</label>
            <select id="vacancy-filter" class="vacancy-filter-select" multiple></select>
        </div>
        <div class="filter-group">
            <label for="recruiter-filter">Рекрутер:</label>
            <select id="recruiter-filter" multiple></select>
        </div>
        <div class="filter-group">
            <label for="priority-toggle">Только приоритетные</label>
            <label class="switch">
                <input type="checkbox" id="priority-toggle" checked>
                <span class="slider round"></span>
            </label>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                {% for header in headers %}
                    <th>{{ header }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% if report_data %}
                {% for row in report_data %}
                     <tr
                      class="{{ 'priority' if row.is_priority else '' }}"
                      data-priority="{{ row.is_priority|string|lower }}"
                      data-members="{{ row.members|tojson }}"
                      data-vacancy-name="{{ row['название вакансии'] }}"
                     >
                        <td>{{ row['название вакансии'] }}</td>
                        {% for stage in ['коннект', 'интервью с HR', 'интервью с заказчиком', 'финальное интервью', 'выставлен оффер', 'вышел на работу'] %}
                            <td>{{ row[stage].total }} ({{ row[stage].current }})</td>
                        {% endfor %}
                        <td class="comment-cell" data-vacancy-name="{{ row['название вакансии'] }}">
                            <span class="editable-comment">{{ row['комментарий'] }}</span>
                        </td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="{{ headers|length }}" class="no-data">
                        Данные не найдены. Возможно, нет активных приоритетных вакансий или произошла ошибка.
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>
{% endblock %}